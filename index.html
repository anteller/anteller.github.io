<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>クイズ集</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="color-scheme" content="light dark">
<link rel="stylesheet" href="./style.css">
</head>
<body data-theme="auto">
<div class="container">
  <h1>クイズ集！</h1>

  <!-- ジャンル選択 -->
  <div id="genreSelect" class="panel" data-screen="genreSelect">
    <p>ジャンルを選んでください（左クリック: プレイ / 右クリック: 管理）</p>
    <div id="genreButtons"></div>
    <div class="info-row" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px;">
      <button class="btn small" id="addGenreBtn" type="button">＋ ジャンル追加</button>
      <button class="btn small" id="addQuestionBtn" type="button">＋ 問題を追加</button>
      <button class="btn small flat" id="settingsBtn" type="button">設定</button>
      <button class="btn small flat" id="manageBtn" type="button" title="最後に選んだジャンルを管理">問題管理</button>
      <button class="btn small flat" id="genreManageBtn" type="button">ジャンル管理</button>
    </div>
    <p style="margin-top:12px;font-size:12px;color:var(--c-text-sub)">
      ※ 出題数や低正答率優先出題は次画面で選択できます
    </p>
  </div>

  <!-- 出題数選択 -->
  <div id="questionCountScreen" class="panel hidden" data-screen="questionCountScreen">
    <h2 id="qCountTitle">出題数を選択</h2>
    <div id="qCountInfo" style="font-size:13px;color:var(--c-text-sub);margin-top:4px;"></div>
    <div class="count-buttons" id="qCountButtons"></div>
    <div class="inline-actions">
      <button class="btn flat small" id="qCountCancelBtn" type="button">← 戻る</button>
    </div>
    <p style="margin:6px 0 0;font-size:11px;color:var(--c-text-sub)">低正答率: 正答率が低い / 未回答を重みに応じランダム優先</p>
  </div>

  <!-- クイズ画面 -->

  <div id="quizScreen" class="panel hidden" data-screen="quizScreen">
    <div class="progress" id="progress"></div>
    <div style="text-align:right;max-width:780px;margin:0 auto;">
      <button id="flagToggleBtn" type="button" class="flag-btn flat"
        title="この問題を要チェックに追加/解除">☆ 要チェック</button>
    </div>
    <div class="question" id="question"></div>
    <div class="choices" id="choicesContainer" role="listbox" aria-label="選択肢"></div>
    <div class="dontknow-wrap">
      <button type="button" id="iDontKnowBtn" class="btn small" aria-label="わからない（不正解として扱う）">わからない</button>
    </div>
    <div class="result-msg" id="result" aria-live="polite"></div>
    <div class="result-sub" id="subResult" aria-live="polite"></div>
    <div id="explanationBox" class="explanation"></div>

    <!-- 低正答率モード出題率調整 -->
    <div id="priorityAdjustWrap" class="hidden">
      <button type="button" id="priorityUpBtn" class="btn small warn" title="この問題の低正答率モードでの出題率を上げる">出題率↑</button>
      <button type="button" id="priorityDownBtn" class="btn small down" title="この問題の低正答率モードでの出題率を下げる">出題率↓</button>
      <span id="priorityIndicator" class="priority-indicator" title="現在の係数 (1が標準)">x1.00</span>
    </div>

    <div class="inline-actions">
      <button class="btn flat small" id="backBtn" type="button">← ジャンルへ</button>
      <button class="btn secondary small" id="nextQuestionBtn" type="button">次の問題へ →</button>
    </div>
    <p style="margin:4px 0 0;font-size:12px;color:var(--c-text-sub)">数字キー 1〜9 / 0=わからない / 左右スワイプ対応</p>
  </div>

  <!-- 結果画面 -->
  <div id="resultScreen" class="panel hidden" data-screen="resultScreen">
    <h2>結果</h2>
    <p id="score" style="font-size:18px;font-weight:600;"></p>
    <!-- ボタンを上部へ -->
    <div class="inline-actions" style="margin:10px 0 20px;">
      <button class="btn" id="retrySameBtn" type="button">同じ条件でもう一度</button>
      <button class="btn secondary" id="backToCountBtn" type="button">出題数を選び直す</button>
      <button class="btn flat" id="backToGenreBtn" type="button">ホーム画面へ</button>
      <button class="btn flat" id="manageFromResultBtn" type="button">問題管理</button>
    </div>

    <div id="retryBlock" class="hidden" style="margin-top:4px;">
      <button class="btn small" id="retryWrongBtn" type="button">間違えた問題だけ再挑戦</button>
    </div>
    <h3 style="margin-top:20px;">間違えた問題</h3>
    <ul id="wrongList" class="wrong-list"></ul>

    <h3 style="margin-top:24px;">正解した問題</h3>
    <ul id="rightList" class="wrong-list right-list"></ul>
  </div>

  <!-- 追加/編集 -->
  <div id="addScreen" class="panel hidden" data-screen="addScreen">
    <h2 id="addEditTitle">新しい問題を追加</h2>
    <form id="addForm" autocomplete="off">
      <label class="form-label">
        ジャンル:
        <select id="genreInput"></select>
      </label>
      <label class="form-label">
        問題文:
        <input type="text" id="questionInput" required placeholder="例: 5 + 7 = ?">
      </label>
      <fieldset>
        <legend>選択肢（2〜6個）</legend>
        <div id="choicesEditArea"></div>
        <button type="button" id="addChoiceBtn" class="add-choice-btn">＋ 選択肢を追加</button>
        <p style="font-size:11px;color:var(--c-text-sub);margin:6px 0 0;">ラジオボタンで正解を選択してください</p>
      </fieldset>
      <label class="form-label">
        解説（任意）:
        <textarea id="explanationInput" placeholder="解説など"></textarea>
      </label>
      <label class="form-label">
        タグ（カンマ区切り 任意）:
        <input type="text" id="tagsInput" placeholder="例: 基礎,計算">
      </label>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:8px;" id="addFormButtons">
        <button type="submit" class="btn" id="submitAddBtn">追加</button>
        <button type="button" id="addAndContinueBtn" class="btn secondary">追加して続ける</button>
        <button type="button" class="btn flat" id="cancelAddBtn">戻る</button>
      </div>
      <div style="display:none;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:8px;" id="editFormButtons">
        <button type="button" class="btn" id="saveEditBtn">更新</button>
        <button type="button" class="btn warn" id="cancelEditBtn">キャンセル</button>
        <button type="button" class="btn flat" id="backToManageBtn">一覧へ戻る</button>
      </div>
    </form>
  </div>

  <!-- 設定 -->
  <div id="settingsScreen" class="panel hidden" data-screen="settingsScreen">
    <h2>設定</h2>
    <form id="settingsForm">
      <fieldset>
        <legend>選択肢シャッフル</legend>
        <label style="display:flex;gap:6px;align-items:center;">
          <input type="checkbox" id="shuffleChoicesInput">
          出題ごとに選択肢の順序をランダムにする
        </label>
        <p style="font-size:12px;color:var(--c-text-sub);margin:4px 0 0;">
          オフにすると登録時の順序で表示（正答位置が固定されるので偏った暗記に注意）
        </p>
      </fieldset>
      <fieldset>
        <legend>進行モード</legend>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <label><input type="radio" name="progressMode" value="auto"> 自動で次へ進む</label>
          <div id="autoDelayWrap" style="margin:0 0 6px 20px;">
            待機秒数: <input type="number" id="autoDelayInput" min="0.3" step="0.1" style="max-width:120px;" />
            <span style="font-size:12px;color:var(--c-text-sub);">0.3〜10.0 (推奨 0.8〜2.0)</span>
          </div>
          <label><input type="radio" name="progressMode" value="manual"> 手動（ボタン / スワイプ）</label>
        </div>
      </fieldset>
      <fieldset>
        <legend>出題数選択肢</legend>
        <p style="font-size:12px;color:var(--c-text-sub);margin:4px 0 6px;">
          正の整数と "all" をカンマ区切り (例: 5,10,20,all)
        </p>
        <input type="text" id="questionCountOptionsInput" placeholder="5,10,20,all">
      </fieldset>
      <fieldset>
        <legend>テーマ</legend>
        <div style="display:flex;gap:18px;flex-wrap:wrap;">
          <label><input type="radio" name="themeMode" value="auto"> 自動(OS追随)</label>
          <label><input type="radio" name="themeMode" value="light"> ライト</label>
          <label><input type="radio" name="themeMode" value="dark"> ダーク</label>
        </div>
      </fieldset>
      <fieldset>
        <legend>Undo 表示時間</legend>
        <p style="font-size:12px;color:var(--c-text-sub);margin:4px 0 6px;">
          削除後に「元に戻す」を表示する秒数。2〜60 秒（既定 7）
        </p>
        <input type="number" id="undoDurationInput" min="2" max="60" step="1" style="max-width:120px;" />
        <span style="font-size:12px;color:var(--c-text-sub);">秒</span>
      </fieldset>
      <fieldset>
        <legend>低正答率モード 出題率調整</legend>
        <label style="display:flex;flex-direction:column;gap:4px;max-width:260px;text-align:left;">
          出題率↑ 係数
          <input type="number" id="priorityIncreaseInput" min="1.05" step="0.05" placeholder="例: 1.4">
        </label>
        <p style="font-size:12px;color:var(--c-text-sub);margin:4px 0 0;">
          「出題率↑」ボタンで weight をこの値倍します。<br>
          「出題率↓」は逆数で割ります (最小0.2〜最大5.0にクランプ)。
        </p>
      </fieldset>
      <fieldset>
        <legend>全体操作</legend>
        <p style="font-size:12px;color:var(--c-text-sub);margin:4px 0 10px;">全データ初期化 (ジャンル・問題・統計)</p>
        <button type="button" class="btn danger small" id="resetAllDataBtn">全データリセット</button>
      </fieldset>
      <div class="inline-actions">
        <button type="submit" class="btn">保存</button>
        <button type="button" id="cancelSettingsBtn" class="btn flat">戻る</button>
      </div>
    </form>
  </div>

  <!-- 問題管理 -->
  <div id="manageScreen" class="panel hidden" data-screen="manageScreen">
    <div class="manage-header">
      <div class="title" id="manageTitle">問題管理</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn small" id="manageAddBtn" type="button">＋ 新規追加</button>
        <button class="btn flat small" id="genreExportBtn" type="button">JSONエクスポート</button>
        <button class="btn flat small" id="genreImportBtn" type="button">JSONインポート</button>
        <input id="genreImportFile" type="file" accept=".json,application/json" class="hidden">
        <button class="btn warn small" id="resetStatsBtn" type="button">正答率リセット</button>
        <button class="btn danger small" id="manageBackBtn2" type="button">戻る</button>
      </div>
    </div>
    <div class="manage-controls">
      <div>
        <label style="font-size:12px;">ジャンル</label>
        <select id="genreFilterSelect"></select>
      </div>
      <div>
        <label style="font-size:12px;">検索（タグ / 問題文 / 選択肢）</label>
        <input type="text" id="tagFilterInput" placeholder="例: 比較 / want / to V">
      </div>
      <div>
        <label style="font-size:12px;">要チェック</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn small flat" id="flaggedFilterBtn" type="button" title="要チェック問題のみ表示を切替">
            ☆ 要チェックのみ
          </button>
        </div>
        <div style="font-size:10px;color:var(--c-text-sub);">トグル表示</div>
      </div>
      <div style="align-self:flex-end;">
        <button class="btn small flat" id="applyFilterBtn" type="button">フィルタ適用</button>
        <button class="btn small flat" id="clearFilterBtn" type="button">クリア</button>
      </div>
    </div>
    <div class="bulk-bar">
      <div class="left">
        <button class="btn small flat" id="selectAllBtn" type="button">全選択</button>
        <button class="btn small flat" id="deselectAllBtn" type="button">選択解除</button>
        <button class="btn small danger" id="bulkDeleteBtn" type="button" disabled>選択削除</button>
      </div>
      <div class="right">
        <span class="bulk-info" id="bulkInfo">0件選択</span>
      </div>
    </div>
    <div id="bulkTagArea" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
      <input type="text" id="bulkTagInput" placeholder="選択問題にタグ追加 (例: 苦手,復習)" style="flex:1;min-width:240px;padding:6px 8px;">
      <button class="btn small" id="bulkTagApplyBtn" type="button" disabled>タグ一括付与</button>
    </div>
    <div class="manage-list-toolbar">
      <div class="sort-compact">
        <select id="sortSelect" aria-label="ソート">
          <option value="original">元の順序</option>
          <option value="accdesc">正答率 高い順</option>
          <option value="accasc">正答率 低い順</option>
          <option value="countdesc">回答数 多い順</option>
          <option value="countasc">回答数 少ない順</option>
        </select>
      </div>
    </div>
    <div id="manageListWrap"></div>
  </div>

  <!-- ジャンル管理 -->
  <div id="genreManageScreen" class="panel hidden" data-screen="genreManageScreen">
    <h2>ジャンル管理</h2>
    <p style="font-size:13px;color:var(--c-text-sub);margin-top:4px;">順序変更・名称変更・削除ができます。</p>
    <ul id="genreManageList" class="genre-manage-list"></ul>
    <div class="inline-actions" style="margin-top:16px;">
      <button class="btn flat" id="genreManageBackBtn" type="button">← 戻る</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" aria-live="polite"></div>

<script type="module" src="./src/main.js"></script>

</body>
</html>
